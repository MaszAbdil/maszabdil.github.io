<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Keuangan - Masz Abdil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">MyFinance</span>
            <a href="index.html" class="btn btn-outline-light btn-sm">Keluar</a>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white shadow-sm">
                    <div class="card-body">
                        <h6>Saldo Saat Ini</h6>
                        <h3 id="displaySaldo">Rp 0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Laporan Keuangan</h5>
                        <div>
                            <button class="btn btn-danger btn-sm me-2" onclick="unduhPDF()">
                                Unduh PDF
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="setSaldoAwal()">Set Saldo Awal</button>
                            <button class="btn btn-outline-danger btn-sm me-2" onclick="hapusSemuaData()">Hapus Semua</button>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#formModal">
                                + Tambah Pengeluaran
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabelKeuangan">
                                <thead class="table-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Tanggal</th>
                                        <th>Nama Item</th>
                                        <th>Pengeluaran</th>
                                        <th>Sisa Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Input Pengeluaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="financeForm">
                        <div class="mb-3">
                            <label class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="tanggal" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Item</label>
                            <input type="text" class="form-control" id="item" placeholder="Contoh: Makan Siang" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Jumlah Pengeluaran (Rp)</label>
                            <input type="number" class="form-control" id="pengeluaran" placeholder="0" required>
                        </div>
                        <div class="modal-footer px-0 pb-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan & Kurangi Saldo</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const financeForm = document.getElementById('financeForm');
        const tabelBody = document.getElementById('tabelBody');
        const displaySaldo = document.getElementById('displaySaldo');

        const formatter = new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        });

        window.onload = function() {
            tampilkanData();
        };

        function setSaldoAwal() {
            const saldo = prompt("Masukkan jumlah Saldo Awal Anda:");
            if (saldo !== null && saldo !== "") {
                localStorage.setItem('saldoAwal', saldo);
                tampilkanData();
            }
        }

        financeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let listData = JSON.parse(localStorage.getItem('keuangan')) || [];
            let saldoAwal = parseFloat(localStorage.getItem('saldoAwal')) || 0;
            let currentSaldo = listData.length > 0 ? listData[listData.length - 1].sisaSaldo : saldoAwal;

            const pengeluaran = parseFloat(document.getElementById('pengeluaran').value);
            const sisaSaldo = currentSaldo - pengeluaran;

            const newData = {
                tanggal: document.getElementById('tanggal').value,
                item: document.getElementById('item').value,
                pengeluaran: pengeluaran,
                sisaSaldo: sisaSaldo
            };

            listData.push(newData);
            localStorage.setItem('keuangan', JSON.stringify(listData));
            tampilkanData();
            financeForm.reset();
            bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
        });

        function tampilkanData() {
            const listData = JSON.parse(localStorage.getItem('keuangan')) || [];
            const saldoAwal = parseFloat(localStorage.getItem('saldoAwal')) || 0;
            tabelBody.innerHTML = '';
            
            listData.forEach((data, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${data.tanggal}</td>
                        <td>${data.item}</td>
                        <td class="text-danger">-${formatter.format(data.pengeluaran)}</td>
                        <td>${formatter.format(data.sisaSaldo)}</td>
                    </tr>
                `;
                tabelBody.innerHTML += row;
            });

            const saldoTerakhir = listData.length > 0 ? listData[listData.length - 1].sisaSaldo : saldoAwal;
            displaySaldo.innerText = formatter.format(saldoTerakhir);
        }

        // FUNGSI UNDUH PDF
        function unduhPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Judul PDF
            doc.text("Laporan Keuangan Pribadi", 14, 15);
            doc.setFontSize(10);
            doc.text("Tanggal Cetak: " + new Date().toLocaleDateString('id-ID'), 14, 22);

            // Ambil data dari tabel HTML
            doc.autoTable({
                html: '#tabelKeuangan',
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [13, 110, 253] } // Warna biru Bootstrap
            });

            // Simpan PDF
            doc.save("Laporan-Keuangan.pdf");
        }

        function hapusSemuaData() {
            if (confirm('Hapus semua transaksi dan reset saldo?')) {
                localStorage.removeItem('keuangan');
                localStorage.removeItem('saldoAwal');
                tampilkanData();
            }
        }
    </script>
</body>
</html>